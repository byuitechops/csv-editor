<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <style>
        body {
            font-family: sans-serif;
        }

        #UI>div:nth-child(odd) {
            background-color: lightgray;
        }

        h3 {
            margin-bottom: 0;
        }

        .editor {
            min-height: 300px;
        }

        .half {
            width: 50%;
            float: left;
        }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.10/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-dsv/1.0.7/d3-dsv.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.8/ace.js"></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/4.6.6/tinymce.min.js"></script>-->
    <script src="./tinymce/js/tinymce/tinymce.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.7/download.min.js"></script>

</head>

<body>
    <script id="template" type="text/x-handlebars-template">
        passage text,skill,level,question name,function,topic,difficulty level,question text,answertext1,answertext2,answertext3,answertext4 {{#each this}}
        <div id="row{{@index}}">
            <h3>passage text</h3>
            <textarea>{{passagetext}}</textarea>
            <h3>skill</h3>
            <input value="{{skill}}" />
            <h3>level</h3>
            <input value="{{level}}" />
            <h3>question name</h3>
            <input value="{{questionname}}" />
            <h3>function</h3>
            <input value="{{function}}" />
            <h3>topic</h3>
            <input value="{{topic}}" />
            <h3>difficulty level</h3>
            <input value="{{difficultylevel}}" />
            <h3>question text</h3>
            <input value="{{questiontext}}" />
            <h3>answertext1</h3>
            <input value="{{answertext1}}" />
            <h3>answertext2</h3>
            <input value="{{answertext2}}" />
            <h3>answertext3</h3>
            <input value="{{answertext3}}" />
            <h3>answertext4</h3>
            <input value="{{answertext4}}" />
        </div>
        {{/each}}
    </script>
    <div class="half">
        <h2>1. Upload a file here.</h2>
        <input type="file" name="file" id="file" />
    </div>
    <div class="half">
        <h2>3. Redownload file here.</h2>
        <button onclick="downloadit()">download</button>
    </div>
    <h2>2. Edit CSV Here</h2>
    <div id="UI"></div>
    <script>
        var file;
        var spaces;
        var file_name;
        document.querySelector('input').addEventListener('change', getFile)

        //        function addAce(ele) {
        //            console.log(ele);
        //            var editor = ace.edit(ele);
        //            editor.setTheme("ace/theme/iplastic");
        //            editor.getSession().setMode("ace/mode/html");
        //        }

        function addAceEditor(stringIn, index) {
            return '<div class="editor" id="editor' + (index + 1) + '" ><textarea>' + stringIn + '</textarea></div>';
        }

        function addTinyMCE() {

            tinymce.init({
                selector: 'textarea',
                height: 300,
                width: '50%',
                menubar: false,
                plugins: [
                    'advlist autolink lists link image charmap print preview anchor textcolor',
                    'searchreplace visualblocks code fullscreen',
                    'insertdatetime media table contextmenu paste definitionlist code help'
                ],
                toolbar: 'insert | undo redo |  styleselect | bold italic backcolor  | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | ToggleDefinitionList ToggleDefinitionItem | code | help',
                content_css: [
                    'http://fonts.googleapis.com/css?family=Lato:300,300i,400,400i',
                    'http://www.tinymce.com/css/codepen.min.css'
                ],
                init_instance_callback: function(editor) {
                    editor.on('KeyUp', function(e) {
                        //console.log(editor.getContent(), this.id);
                        var textarea = document.querySelector("#" + this.id)
                        textarea.dataset.editortext = (editor.getContent({format: 'raw'}));
                        saveData(textarea);
                        //console.log(textarea.dataset.editortext);

                    });
                }
            });
        }

        function makeUI(data) {
            console.log(data)
            file = data;
            console.log(file);
            var template = Handlebars.compile(document.querySelector('#template').innerHTML);
            document.querySelector('#UI').innerHTML = template(data);

            //add ace
            //Array.from(document.querySelectorAll('textarea')).forEach(addAce)
            function addAce() {

                var needsAce = document.getElementsByTagName("textarea");

                for (var i = 0; i < needsAce.length; i++) {
                    needsAce[i].outerHTML = addAceEditor(needsAce[i].innerHTML, i);
                }
                renderAceEditor();
            }

            //addAce();
            addTinyMCE();

            addListeners();
        }

        function addListeners() {
            //add change event listener to inputs
            var inputs = document.getElementsByTagName("input");

            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('keyup', function(event) {
                    saveData(this);
                }, false);
            }

            //add change event listener to editors


            var editors = document.querySelectorAll("textarea");

            for (var i = 0; i < editors.length; i++) {
                editors[i].addEventListener('keyup', function(event) {
                    saveData(this);
                }, false);
            }



        }



        function renderAceEditor() {
            $('.editor').each(function(index, element) {
                // Make the document object to count the lines


                var editor = ace.edit(element);

                editor.setTheme("ace/theme/chrome");

                editor.setAutoScrollEditorIntoView(true);
                editor.setOptions({
                    fontFamily: "monospace",
                    fontSize: "16px",
                    // Only display 30 lines, if result is longer than 30 lines
                    minLines: 10
                })
                editor.getSession().setMode("ace/mode/html");
            });
        }


        function getFile() {
            var file = this.files[0]
            var reader = new FileReader();
            reader.onload = function(e) {
                var fileData = e.target.result;

                //need to fix the spaces in the obj props 
                makeUI(d3.csvParse(fileData).map(function(item) {
                    spaces = Object.keys(item);
                    return Object.keys(item).reduce(function(objOut, key) {
                        objOut[key.replace(/ /g, '')] = item[key];
                        return objOut;
                    }, {});
                }));
                file_name = document.querySelector("#file").value;
                //This should work the first time but it doesn't
                file_name = file_name.split("fakepath")[1].replace("\\", "");
            };
            reader.readAsText(file);

        }

        function saveData(element) {
            // Get which row of the CSV to change
            var row = parseInt(element.parentElement.id.split("row")[1]);
            var columnName = element.previousElementSibling.innerHTML.replace(' ', '');

            //            console.log(row, columnName);
            //            console.log(file[row][columnName]);
            if (element.tagName == "TEXTAREA") {
                // DO IT TWICE, BECAUSE MCE
                var columnName = element.previousElementSibling.previousElementSibling.innerHTML.replace(' ', '');
                //console.log(element.dataset.editortext);
                //console.log(file[row][columnName]);
                file[row][columnName] = element.dataset.editortext;
                //console.log(file[row][columnName]);
            } else {
                var columnName = element.previousElementSibling.innerHTML.replace(' ', '');
                file[row][columnName] = element.value;
                // console.log(file[row][columnName])
            }

            //            console.log(file[row][columnName]);
        }


        function downloadit() {
            var exported = d3.csvFormat(file);
            download(exported, file_name, "text/plain");
        }

    </script>
</body>

</html>
